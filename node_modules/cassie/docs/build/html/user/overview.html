


<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. Overview &mdash; Cassie v1.3.1 documentation</title>
    <link rel="stylesheet" href="../_static/screen.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Cassie v1.3.1 documentation" href="../index.html" />
    <link rel="up" title="Learning Cassie" href="index.html" />
    <link rel="next" title="2. Getting Started" href="getting-started.html" />
    <link rel="prev" title="Learning Cassie" href="index.html" /> 
  </head>
  <body>
   <div id="header">
     <h1 class="project-name"><a href="../index.html">Cassie</a></h1>
     <div class="project-version">version 1.3.1</div>
     <div class="chapter-wrapper">
       <h2 class="chapter">
           <a href="index.html"accesskey="U"
              >Learning Cassie</a>
            ›               
         1. Overview
       </h2>
     </div>
   </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="overview">
<span id="index-0"></span><h1>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>Cassie is a short and self contained library that adds support for <em>Promises</em>
in JavaScript. It&#8217;s designed to help people manage complex asynchronous
dependencies without getting all tangled up in callback messes and loosing the
composition power that JavaScript as a language provides. It&#8217;s also designed to
be easily extensible, such that people can provide specialised promises for
more complex problem domains — for an example of that, see <a class="reference external" href="https://github.com/killdream/iris">Iris</a>.</p>
<div class="section" id="why-use-it">
<span id="index-1"></span><h2>1.1. Why use it?<a class="headerlink" href="#why-use-it" title="Permalink to this headline">¶</a></h2>
<p>JavaScript is a single-threaded, synchronous, top-down, left-right, strict
evaluated scripting language, but environments (specially <a class="reference external" href="http://nodejs.org/">Node.js</a>) provide
asynchronous functions to enable light-weight concurrency.</p>
<p>As such, <a class="reference external" href="http://en.wikipedia.org/wiki/Event-driven_programming">Event-Driven Programming</a> and <a class="reference external" href="http://en.wikipedia.org/wiki/Continuation-passing_style">Continuation-Passing Style</a> have
become rather popular patterns when working in a JavaScript code-base. You ask
the engine to do something, but instead of blocking everything until that thing
is done, you just provide a <tt class="docutils literal"><span class="pre">Function</span></tt> that the engine should call once the
task is done so you can continue processing the data.</p>
<p>Unfortunately, this quickly leads to clusterfucks of callbacks, most of the
times:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="sr">/2\d{2}/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">()</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">)</span>  <span class="k">return</span>

    <span class="nx">view</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">process</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="p">}}</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">.</span><span class="nx">bind</span><span class="p">(),</span> <span class="mi">10</span><span class="nx">e3</span><span class="p">)</span>
</pre></div>
</div>
<p>With promises, one could achieve this:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cassie&#39;</span><span class="p">).</span><span class="nx">Promise</span>
<span class="kd">var</span> <span class="nx">sequentially</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cassie/src/sequencing&#39;</span><span class="p">)</span>

<span class="nx">req</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span>
   <span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
   <span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="nx">sequentially</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">process</span><span class="p">))</span> <span class="p">})</span>

<span class="kd">function</span> <span class="nx">process</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">make</span><span class="p">()</span>
  <span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">do_process</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
                           <span class="nx">view</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
                           <span class="nx">promise</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">promise</span> <span class="p">}}</span>
</pre></div>
</div>
<p>At first glance it doesn&#8217;t seem to have changed much, although one could (arguably) say
that the <em>Promise</em> based example reads better. None the less, we can see some
improvements in the <em>Promise</em> based example:</p>
<blockquote>
<div><ul class="simple">
<li>Success and failure are properly separated, and are easily recognisable.</li>
<li>Process is now a <tt class="docutils literal"><span class="pre">Function</span></tt> over single items, that can be easily
abstracted and combined — even though it&#8217;s asynchronous.</li>
<li>Using the <tt class="docutils literal"><span class="pre">sequentially</span></tt> utility, we can do <em>Promise</em> based tasks in
sequence, without dealing explicitly with ordering and success/failure of
each task individually. Tasks just need to handle themselves —
<tt class="docutils literal"><span class="pre">sequentially</span></tt> is just a wrapper over the lower level <tt class="docutils literal"><span class="pre">Promise#wait</span></tt>
method, that lets you declare dependencies between promises, so you can
other kinds of control-flow logic.</li>
<li><tt class="docutils literal"><span class="pre">then</span></tt> allows chaining of transformations over the bound value of a
promise. In this case, we can separate the projection in an appropriate
representation from the processing of such representation — loosing
coupling and maximising composition of processes/function.</li>
</ul>
</div></blockquote>
<p>Promises do even better when we have to handle complex dependencies. For
example, if we should fire three different requests, in sequence, but only
firing the next if the previous hasn&#8217;t failed, we could simply do:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">sequentially</span><span class="p">(</span> <span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
            <span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;/foo/bar&#39;</span><span class="p">)</span>
            <span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;/foo/bar/baz&#39;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;All requests successfully processed.&#39;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">failed</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;The following request failed:&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Or, if we need to apply a transformation to one of the tasks and process it
later on:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">sequentially</span><span class="p">(</span> <span class="nx">with_logging</span><span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
            <span class="p">,</span> <span class="nx">as_json</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;/foo/bar&#39;</span><span class="p">))</span>
            <span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;/foo/bar/baz&#39;</span><span class="p">))</span>

<span class="kd">function</span> <span class="nx">with_logging</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">uri</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">action</span><span class="p">(</span><span class="nx">uri</span><span class="p">).</span><span class="nx">ok</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;[OK]&#39;</span><span class="p">,</span> <span class="nx">uri</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">failed</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="s1">&#39;[FAILED]&#39;</span><span class="p">,</span> <span class="nx">uri</span><span class="p">))</span> <span class="p">}}</span>

<span class="kd">function</span> <span class="nx">as_json</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">action</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>You get the idea.</p>
</div>
<div class="section" id="cool-how-do-i-use-it">
<h2>1.2. Cool! How do I use it?<a class="headerlink" href="#cool-how-do-i-use-it" title="Permalink to this headline">¶</a></h2>
<p>Well, glad you asked, me dear, because we&#8217;re just about to reach that part in
particular: &#8220;How do you use <em>Promises</em>?&#8221;. As we answer that question, we&#8217;ll
<a class="reference internal" href="getting-started.html"><em>dabble a little more in the concepts of Promises</em></a>
through usage scenarios.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
    <form class="search"
          action="../search.html"
          method="get">
      <input type="text" name="q" size="18" 
             placeholder="Search the docs..." />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

<div id="toc">
  <ul>
<li><a class="reference internal" href="#">1. Overview</a><ul>
<li><a class="reference internal" href="#why-use-it">1.1. Why use it?</a></li>
<li><a class="reference internal" href="#cool-how-do-i-use-it">1.2. Cool! How do I use it?</a></li>
</ul>
</li>
</ul>

</div>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
 <div id="footer">
   <ul class="panel-links">
     <li>
       <a href="../index.html" accesskey="H">Home</a>
     </li>
     <li>
       <a href="../search.html" accesskey="S">Search</a>
     </li>
     <li>
       <a href="../genindex.html" accesskey="I">Index</a>
     </li>
     
     <li>
       <a href="index.html"
          title="previous chapter"
          accesskey="P">‹ Previous</a>
     </li>
     
     
     <li>
       <a href="../_sources/user/overview.txt"
          rel="nofollow">Source</a>
     </li>
     
     
     <li>
       <a href="getting-started.html"
          title="next chapter"
          accesskey="N">Next ›</a>
     </li>
     
   </ul>
   <div class="copyright">
     <span class="copy-info">
       
         &copy; 2012, Quildreen Motta
       
     </span>
     <span class="gen-info">
       
         Hacked on <a href="https://github.com/killdream/caffeine-theme">C<sub>8</sub>H<sub>10</sub>N<sub>4</sub>O<sub>2</sub></a> + <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8
       
     </span>
   </div>
 </div>

<script>
void function($) {
  var sidebar   = $('.sphinxsidebar')
  var sidebar_y = sidebar.offset().top
  var breath    = $('#footer').height() * 2 + 20
  var toc       = []


  // Maps a reference to a (referedOffset, referee) tuple
  // with_distance :: jQuery -> [Number, jQuery]
  function with_distance(e) {
    return { offset: $($(e).attr('href')).offset().top
           , item:   $(e) } }

  // Highlights the current active topic, based on the given offset
  // highlight_current_topic :: [(Number, jQuery)], Number -> ()
  function highlight_current_topic(topics, offset) {
    var active = topics[0]?  topics[0].item : $()
    topics.forEach(function(e){ e.item.removeClass('active') })
    topics.every(function(e) {
      if (e.offset <= offset)  return active = e.item  })
    active.addClass('active') }

  // Normalises the sidebar positioning for readability depending on the offset
  // normalise_sidebar :: Number, Number, Number -> ()
  function normalise_sidebar(offset, height, breath) {
    if (offset > sidebar_y)
      sidebar.css({ position: 'fixed'
                  , top: '10px'
                  , height: height - breath
                  , width: '210px' })
    else
      sidebar.css({ position: 'static'
                  , top: 'auto'
                  , height: 'auto'
                  , width: '200px' })}
                      

  $(window).bind('scroll', function() {
    normalise_sidebar(window.scrollY, window.innerHeight, breath)
    highlight_current_topic(toc, window.scrollY)
  })

  $(window).bind('resize', function() {
    if (sidebar.css('position') == 'fixed')
      sidebar.height(window.innerHeight - breath)
  })

  $(window).bind('load', function() {
    toc = $('.sphinxsidebar #toc ul ul a.reference.internal').toArray()
                                                             .map(with_distance) })

}(jQuery)
</script>

  </body>
</html>